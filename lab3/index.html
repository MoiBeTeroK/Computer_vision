<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gaussian Blur JS</title>
    <style>
        .container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>

<h2>Оригинал и размытие Гаусса</h2>

<div class="container">
    <div>
        <h3>Оригинал</h3>
        <canvas id="original"></canvas>
    </div>
    <div>
        <h3>После размытия</h3>
        <canvas id="blurred"></canvas>
    </div>
</div>

<script>
const img = new Image();
img.src = 'image.jpg';
img.onload = () => {
    const scale = 480 / img.width;
    const width = Math.round(img.width * scale);
    const height = Math.round(img.height * scale);

    const canvasOrig = document.getElementById('original');
    canvasOrig.width = width;
    canvasOrig.height = height;
    const ctxOrig = canvasOrig.getContext('2d');
    ctxOrig.drawImage(img, 0, 0, width, height);

    const imageData = ctxOrig.getImageData(0, 0, width, height);
    const data = imageData.data;

    const kernelSize = 9;
    const sigma = 4;
    const kernel = createGaussianKernel(kernelSize, sigma);
    const blurredData = gaussianBlur(data, width, height, kernel, kernelSize);

    const canvasBlur = document.getElementById('blurred');
    canvasBlur.width = width;
    canvasBlur.height = height;
    const ctxBlur = canvasBlur.getContext('2d');
    ctxBlur.putImageData(new ImageData(blurredData, width, height), 0, 0);
};

function createGaussianKernel(n, sigma) {
    const kernel = [];
    const a = Math.floor(n / 2);
    let sum = 0;
    for (let y = 0; y < n; y++) {
        kernel[y] = [];
        for (let x = 0; x < n; x++) {
            const exponent = -((x - a)**2 + (y - a)**2) / (2 * sigma**2);
            kernel[y][x] = (1 / (2 * Math.PI * sigma**2)) * Math.exp(exponent);
            sum += kernel[y][x];
        }
    }
    for (let y = 0; y < n; y++) {
        for (let x = 0; x < n; x++) {
            kernel[y][x] /= sum;
        }
    }
    return kernel;
}

function gaussianBlur(data, width, height, kernel, n) {
    const offset = Math.floor(n / 2);
    const output = new Uint8ClampedArray(data.length);
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            let r = 0, g = 0, b = 0;
            for (let ky = 0; ky < n; ky++) {
                for (let kx = 0; kx < n; kx++) {
                    const px = Math.min(Math.max(x + kx - offset, 0), width - 1);
                    const py = Math.min(Math.max(y + ky - offset, 0), height - 1);
                    const idx = (py * width + px) * 4;
                    r += data[idx] * kernel[ky][kx];
                    g += data[idx+1] * kernel[ky][kx];
                    b += data[idx+2] * kernel[ky][kx];
                }
            }
            const idx = (y * width + x) * 4;
            output[idx] = Math.round(r);
            output[idx+1] = Math.round(g);
            output[idx+2] = Math.round(b);
            output[idx+3] = data[idx+3];
        }
    }
    return output;
}
</script>
</body>
</html>
